<!doctype html>
<html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>go OFFLINE</title>
<style>
body {
  font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
  max-width: 500px;
  margin: 100px auto;
}

.offline #offline {
  color: green;
}

.title {
  font-size: 50px;
}

.i {
  position: relative;
}

.score {
  opacity: 0;
}

.offline .score {
  opacity: 1;
}

.share {
  opacity: 0;
}

.hiscore .share {
  opacity: 1;
}

.wifi {
  position: absolute;
  top: -25px;
  left: 50%;
  margin-left: -25px;
}

/* https://codepen.io/GilSanchez/pen/rusAy */
.wifi {
	padding: 5px;
}

.wifi, .wifi:before {
	display: block;
	border: 15px double transparent;
	border-top-color: currentColor;
	border-radius: 50%;
}

.wifi::before {
	content: '';
	width: 0; height: 0;
  border: 5px solid transparent;
	border-top-color: currentColor;
}

.offline .wifi {
  border-color: transparent;
}

.star {
  transition: opacity 500ms;
  opacity: 0;
}

.achievement {
  transition: opacity 500ms;
  opacity: 0.5;
  text-decoration: line-through;
}

.unlocked {
  opacity: 1;
  text-decoration: none;
}

.unlocked .star {
  opacity: 1;
}

</style>
<body>
<h1 class="title">
  go <span id="offline">OFFL<span class="i">I<span class="wifi"></span></span>NE</span>
</h1>
<p>
  HI SCORE: <span id="js-hiscore">0</span>
  <span class="share">- <a href="https://twitter.com/" target="_blank" id="js-share">SHARE</a> YOUR NEW HI SCORE!</span>
</p>
<p class="score">&nbsp;&nbsp;&nbsp;SCORE: <span id="js-score">0</span></p>

<h3> ACHIEVEMENTS </h3>
<p class="achievement" id="js-achievement-0"><span class="star">&#9733; </span>go offline</p>
<p class="achievement" id="js-achievement-1"><span class="star">&#9733; </span>be offline</p>
<p class="achievement" id="js-achievement-2"><span class="star">&#9733; </span>13 seconds to Mars</p>
<p class="achievement" id="js-achievement-3"><span class="star">&#9733; </span>leet</p>
<p class="achievement" id="js-achievement-4"><span class="star">&#9733; </span>get lucky</p>
<p class="achievement" id="js-achievement-5"><span class="star">&#9733; </span>sharing is caring</p>
<p class="achievement" id="js-achievement-6"><span class="star">&#9733; </span>distracted</p>
<p class="achievement" id="js-achievement-7"><span class="star">&#9733; </span>cheater</p>
<p class="achievement" id="js-achievement-8"><span class="star">&#9733; </span>tool up</p>
<p class="achievement" id="js-achievement-9"><span class="star">&#9733; </span>hi</p>
<p class="achievement" id="js-achievement-10"><span class="star">&#9733; </span>stayin' online</p>
<p class="achievement" id="js-achievement-13"><span class="star">&#9733; </span>13:13:13</p>

<script>
/**
 * https://github.com/mneubrand/jsfxr
 *
 * Copyright 2010 Thomas Vian
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * @author Thomas Vian
 */
function SfxrParams(){this.setSettings=function(r){for(var a=0;a<24;a++)this[String.fromCharCode(97+a)]=r[a]||0;this.c<.01&&(this.c=.01);var t=this.b+this.c+this.e;if(t<.18){var e=.18/t;this.b*=e,this.c*=e,this.e*=e}}}function SfxrSynth(){var r,a,t,e,s,n,i,h,f,c,o,v;this._params=new SfxrParams,this.reset=function(){var r=this._params;e=100/(r.f*r.f+.001),s=100/(r.g*r.g+.001),n=1-r.h*r.h*r.h*.01,i=-r.i*r.i*r.i*1e-6,r.a||(o=.5-r.n/2,v=5e-5*-r.o),h=1+r.l*r.l*(r.l>0?-.9:10),f=0,c=1==r.m?0:(1-r.m)*(1-r.m)*2e4+32},this.totalReset=function(){this.reset();var e=this._params;return r=e.b*e.b*1e5,a=e.c*e.c*1e5,t=e.e*e.e*1e5+12,3*((r+a+t)/3|0)},this.synthWave=function(u,b){var w=this._params,m=1!=w.s||w.v,y=w.v*w.v*.1,g=1+3e-4*w.w,k=w.s*w.s*w.s*.1,S=1+1e-4*w.t,l=1!=w.s,p=w.x*w.x,d=w.g,x=w.q||w.r,A=w.r*w.r*w.r*.2,q=w.q*w.q*(w.q<0?-1020:1020),M=w.p?32+((1-w.p)*(1-w.p)*2e4|0):0,_=w.d,U=w.j/2,j=w.k*w.k*.01,C=w.a,P=r,R=1/r,W=1/a,z=1/t,B=5/(1+w.u*w.u*20)*(.01+k);B>.8&&(B=.8),B=1-B;for(var D,E,F,G,H,I,J=!1,K=0,L=0,N=0,O=0,Q=0,T=0,V=0,X=0,Y=0,Z=0,$=new Array(1024),rr=new Array(32),ar=$.length;ar--;)$[ar]=0;for(ar=rr.length;ar--;)rr[ar]=2*Math.random()-1;for(ar=0;ar<b;ar++){if(J)return ar;if(M&&++Y>=M&&(Y=0,this.reset()),c&&++f>=c&&(c=0,e*=h),(e*=n+=i)>s&&(e=s,d>0&&(J=!0)),E=e,U>0&&(Z+=j,E*=1+Math.sin(Z)*U),(E|=0)<8&&(E=8),C||((o+=v)<0?o=0:o>.5&&(o=.5)),++L>P)switch(L=0,++K){case 1:P=a;break;case 2:P=t}switch(K){case 0:N=L*R;break;case 1:N=1+2*(1-L*W)*_;break;case 2:N=1-L*z;break;case 3:N=0,J=!0}x&&((F=0|(q+=A))<0?F=-F:F>1023&&(F=1023)),m&&g&&((y*=g)<1e-5?y=1e-5:y>.1&&(y=.1)),I=0;for(var tr=8;tr--;){if(++V>=E&&(V%=E,3==C))for(var er=rr.length;er--;)rr[er]=2*Math.random()-1;switch(C){case 0:H=V/E<o?.5:-.5;break;case 1:H=1-V/E*2;break;case 2:H=.225*(((H=1.27323954*(G=6.28318531*((G=V/E)>.5?G-1:G))+.405284735*G*G*(G<0?1:-1))<0?-1:1)*H*H-H)+H;break;case 3:H=rr[Math.abs(32*V/E|0)]}m&&(D=T,(k*=S)<0?k=0:k>.1&&(k=.1),l?(Q+=(H-T)*k,Q*=B):(T=H,Q=0),O+=(T+=Q)-D,H=O*=1-y),x&&($[X%1024]=H,H+=$[(X-F+1024)%1024],X++),I+=H}I*=.125*N*p,u[ar]=I>=1?32767:I<=-1?-32768:32767*I|0}return b}}var synth=new SfxrSynth;window.jsfxr=function(r){synth._params.setSettings(r);var a=synth.totalReset(),t=new Uint8Array(4*((a+1)/2|0)+44),e=2*synth.synthWave(new Uint16Array(t.buffer,44),a),s=new Uint32Array(t.buffer,0,44);s[0]=1179011410,s[1]=e+36,s[2]=1163280727,s[3]=544501094,s[4]=16,s[5]=65537,s[6]=44100,s[7]=88200,s[8]=1048578,s[9]=1635017060,s[10]=e,e+=44;for(var n=0,i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",h="data:audio/wav;base64,";n<e;n+=3){var f=t[n]<<16|t[n+1]<<8|t[n+2];h+=i[f>>18]+i[f>>12&63]+i[f>>6&63]+i[63&f]}return h};
</script>

<script>

// TODO: enable offline service worker
// if ('serviceWorker' in navigator) {
//   navigator.serviceWorker
//      .register('sw.js');
// }

  var defaultGameData = { hiScore: 0, achievements: [] };

  const ACHIEVEMENT_GO_OFFLINE = 0;
  const ACHIEVEMENT_BE_OFFLINE = 1;
  const ACHIEVEMENT_13_SECONDS = 2;
  const ACHIEVEMENT_LEET       = 3;
  const ACHIEVEMENT_GET_LUCKY =  4;
  const ACHIEVEMENT_SHARING =    5;
  const ACHIEVEMENT_DISTRACTED = 6;
  const ACHIEVEMENT_CHEATER    = 7;
  const ACHIEVEMENT_TOOL_UP    = 8;
  const ACHIEVEMENT_HI_SCORE   = 9;
  const ACHIEVEMENT_ONLINE     = 10;
  const ACHIEVEMENT_13_13_13   = 13;

  function readGameData() {
    if (localStorage) {
      var gameData;

      try {
        gameData = JSON.parse(localStorage.getItem('GO_OFFLINE_DATA'));
      } catch(e) {
        // ignore and return default
      }
    }

    return gameData || defaultGameData;
  }

  function saveGameData(data) {
    if (localStorage) {
      try {
        localStorage.setItem('GO_OFFLINE_DATA', JSON.stringify(data))
      } catch (e) {
        // silently ignore
      }
    }
  }

  function getShareUrl(score) {
    var url = "https://twitter.com/share?url=" +
      window.location +
      "&text=I've just spent " + score + " seconds offline in Go Offline game, and first thing I'm doing is sharing it..." +
      "&hashtags=js13k,AchievementUnlocked"

    return url;
  }

  function devToolsOpen() {
    // https://stackoverflow.com/questions/7798748/find-out-whether-chrome-console-is-open
    var devtools = /./;

    devtools.toString = function() {
      this.opened = true;
    }

    console.log('%c', devtools);
    return !!devtools.opened;
  }

  var data = readGameData();

  function unlockAchievement(i) {
    if (!data.achievements[i]) {
      var soundURL = jsfxr([1,,0.0373,,0.2005,0.3599,,0.3733,,,,,,,,0.629,,,1,,,,,0.5]);
      var player = new Audio();
      player.src = soundURL;
      player.play();

      data.achievements[i] = true;
      document.querySelector('#js-achievement-' + i).classList.add('unlocked');
      saveGameData(data);
    }
  }

  document.querySelector('#js-hiscore').innerHTML = data.hiScore;

  // init achievements
  data.achievements.forEach(function (achievement, i) {
    if (achievement) {
      document.querySelector('#js-achievement-' + i).classList.add('unlocked');
    }
  });

  document.querySelector('#js-share').addEventListener('click', function() {
    unlockAchievement(ACHIEVEMENT_SHARING);
  });

  document.addEventListener('visibilitychange', function() {
    if (!document.hidden && !navigator.onLine) {
      unlockAchievement(ACHIEVEMENT_DISTRACTED);
    }
  });

  if ('onLine' in navigator) {

    var onlineTime = 0;
    var onlineTick = setInterval(function () {
      if (!document.hidden && navigator.onLine) {
        onlineTime++;
        if (data.hiScore > 0 && onlineTime >= data.hiScore) {
          unlockAchievement(ACHIEVEMENT_ONLINE);
          clearInterval(onlineTick);
        }
      } else {
        onlineTime = 0;
      }
    }, 1000);

    if (!navigator.onLine) {
      unlockAchievement(ACHIEVEMENT_BE_OFFLINE);
      onOffline();
    }

    var score;
    var scoreTick;

    function onOffline() {
      unlockAchievement(ACHIEVEMENT_GO_OFFLINE);

      if (devToolsOpen()) {
        unlockAchievement(ACHIEVEMENT_TOOL_UP);
      }

      score = 0;
      document.querySelector('#js-score').innerHTML = score;
      document.body.classList.remove('hiscore');
      document.body.classList.add('offline');

      scoreTick = window.setInterval(function () {
        if (!document.hidden) {
          var domScore = +document.querySelector('#js-score').innerHTML;

          if (score !== domScore) {
            unlockAchievement(ACHIEVEMENT_CHEATER);
            score = score < domScore ? score : domScore;
          }
          score++;

          if (score === 13) {
            unlockAchievement(ACHIEVEMENT_13_SECONDS);
          }

          if (score === 1337) {
            unlockAchievement(ACHIEVEMENT_LEET);
          }

          var date = new Date();
          if (date.getHours() === 13 && date.getMinutes() === 13 && date.getSeconds() === 13) {
            unlockAchievement(ACHIEVEMENT_13_13_13);
          }

          document.querySelector('#js-score').innerHTML = score;
        }
      }, 1000)
    }

    function onOnline() {
      if (!~~(Math.random() * 13)) {
        unlockAchievement(ACHIEVEMENT_GET_LUCKY)
      }

    	document.body.classList.remove('offline');
      if (score > data.hiScore) {
        if (data.hiScore > 0) {
          unlockAchievement(ACHIEVEMENT_HI_SCORE);
        }

        data.hiScore = score;
        document.body.classList.add('hiscore');
        document.querySelector('#js-hiscore').innerHTML = score;
        document.querySelector('#js-share').href = getShareUrl(score);
        saveGameData(data);
      }
      window.clearInterval(scoreTick);
    }

    window.addEventListener('offline', onOffline);
    window.addEventListener('online', onOnline);
  }
</script>
</body>
</html>
